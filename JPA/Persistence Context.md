# 영속성 컨텍스트
* EntityManager로 엔티티를 조회, 저장하면 EntityManager는 영속성 컨텍스트에 보관하고 관리
* em.persist() ==> **DB에 저장하는 것이 아닌 영속성 컨텍스트에 저장하는 것** 

## 영속성 컨텍스트 LifeCycle
* 비영속
* 영속 ==> 영속성 컨텍스트가 관리하는 상태임을 뜻한다.
* 준영속
* 삭제

## 영속성 컨텍스트의 특징
* 1차 캐시
  - 캐시는 운영체제를 배울 때 배워서 알고 있지만, 쉽게 얘기해 자주 사용되는 것을 올려두는 곳 정도로 이야기 할 수 있다.
  - **영속성 컨텍스트는 내부적으로 캐시를 가지고 있어, 영속 상태의 엔티티는 모두 이 캐시에 저장된다.**
  - 만약 특정 엔티티를 조회하게되면 제일 먼저 영속성 컨텍스트의 캐시에서 조회를 하게 된다. 만약 Cache Hit(존재하면)라면 엔티티를 반환
  - Cache Miss(존재x)라면 DB에서 조회한다.
* 동일성 보장
  - 동등성은 인스턴스는 다르지만 내부의 값이 같은 것을 의미하고 **동일성이란 실제 객체 인스턴스가 같기 때문에 참조값이 같음을 의미한다.**
  - **JPA는 영속성 컨텍스트를 사용하여 조회를 할 때마다 항상 같은 객체 인스턴스를 반환함을 보장한다.**
* 트랜잭션을 지원하는 쓰기 지연
  - 등록, 수정, 삭제 등의 쓰기 쿼리는 트랜잭션 안에서 수행되고 트랜잭션 종료시점에 커밋이 되며 수행된다.
  - 따라서, 이 **쓰기 쿼리가 발생할 때마다 DB에 전송하더라도 결국 DB에 실제 반영되는 것은 커밋이 되는 시점이라는 소리다.**
  - JPA는 이를 활용하여 쓰기 쿼리를 내부 저장소에 모아두었다가 트랜잭션이 커밋되는 시점에 한번에 DB에 전송하여 성능을 최적화한다.
* 변경 감지(Dirty Checking)
  - 영속 상태가 될 때 최초 상태를 저장한다. ==> 스냅샷
  - flush가 되는 시점에 현재 엔티티와 스냅샷과 비교하여 바뀐 부분이 존재하면 자동으로 수정 쿼리가 나간다.
* 지연 로딩(Lazy Loading)
  - 지연 로딩이란 실제로 로딩하는 것이 아닌 proxy객체를 생성한 뒤에 실제로 접근이 발생할 때 조회를 하여 값을 가져오는 것을 뜻한다.
