# `@Retryable`과 `@Recover`

`Spring Framework`는 실패한 작업을 재시도하는 기능을 제공하는데 이는 작업이 일시적인 오류에 의해 실패했을 때 사용할 수 있다.

일시적인 오류에는 `Rest API`에서 네트워크 지연으로 인한 오류를 예시로 들 수 있다.

## 의존성
`Spring Retry`에 대한 의존성은 `Spring Boot`를 사용한다면 기본적으로 들어있기 떄문에 별도의 추가는 필요하지 않다.

하지만 추가로 `Spring AOP`에 대한 의존성은 추가해주어야한다.

![스크린샷 2022-03-30 오후 10 28 13](https://user-images.githubusercontent.com/60773356/160845761-1273e006-56a4-4efb-84cd-1e05815ed896.png)


---

## `@Retryable`
메서드 레벨에 `@Retryable` 애노테이션을 붙이는 것으로 사용할 수 있는데 동작을 위해서는 메인 메서드에 `@EnableRetry`를 붙여주여야 동작한다.

![스크린샷 2022-03-30 오후 10 39 38](https://user-images.githubusercontent.com/60773356/160848095-044b210f-bd89-4ec0-a751-810cbbeb0e1d.png)

![스크린샷 2022-03-30 오후 10 40 06](https://user-images.githubusercontent.com/60773356/160848182-d518c27a-df60-4f28-bebb-c3962647d48f.png)

이와 같이 무조건 `RuntimeException`을 발생시키고 `@Retryable`을 메서드 레벨에 붙여주면 되는데

아무 옵션을 지정해주지 않으면 모든 예외가 발생했을 때 재시도를 하는데 1초 간격으로 3번 재시도한다.

물론 옵션을 지정해주어 어떤 예외가 발생했을 때 몇초 간격으로 몇번 재시도할지를 지정해줄 수 있다.

![스크린샷 2022-03-30 오후 10 43 07](https://user-images.githubusercontent.com/60773356/160848833-fbd37734-d4e0-434c-848f-d76c95d4cefb.png)
- `RuntimeException`이 발생했을 때 2초 간격으로 5번 재시도한다.

이 메서드를 실행시켜보면 무조건 예외가 발생하기 때문에 5번의 재시도 후에는 결국 예외가 발생해 애플리케이션이 종료된다.

이를 복구하기위해 사용하는 애노테이션이 바로 `@Recover`이다.

---

## `@Recover`
![스크린샷 2022-03-30 오후 10 47 16](https://user-images.githubusercontent.com/60773356/160849718-40f06959-86cc-4d24-b407-9d219f7e29ed.png)

`@Retryable`을 통해 재시도를 했지만 결국 예외가 발생했을 때 `@Recover`이 붙은 메서드가 실행된다.

이 때 해당 메서드의 파라미터로 어떤 예외에 대한 복구를 실행할 것인지를 지정할 수 있지만 위와 같이 파라미터를 지정하지 않았을 때는 모든 예외에 대해 해당 메서드가 실행된다.

![스크린샷 2022-03-30 오후 10 49 04](https://user-images.githubusercontent.com/60773356/160850126-443bdc96-e9a4-4dac-8dd9-5bbbda71c331.png)
- 로그를 살펴보면 `@Recover` 메서드가 실행되었고 예외 처리가 되어 애플리케이션이 종료되지 않고 계속 실행되고 있다.

![스크린샷 2022-03-30 오후 10 50 03](https://user-images.githubusercontent.com/60773356/160850339-089a4470-7624-47cf-90cb-a0c72426d3f8.png)
- 이렇게 파라미터로 어떤 예외가 발생했을 때 해당 복구 메서드가 실행될지를 지정해줄 수 있다.
- 위의 `@Retryable` 메서드에서는 `RuntimeException`을 던지고 있지만 `@Recover`에서는 `SQLException`에 대해 동작하기 때문에 해당 메서드는 실행되지 않는다.

---

#### `Spring`이 제공하는 재시도 기능을 사용하면 매우 편리하게 재시도 및 복구를 이용할 수 있음을 기억하자!!

